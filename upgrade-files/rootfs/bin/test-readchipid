#!/bin/sh
#
# Usages:
#
# 1. test-readchipid [chip_num]            (Default device: /dev/ttyS2)
# 2. test-readchipid /dev/ttyS3 [chip_num]
#

isH3Platform=false  

cpuinfo=`cat /proc/cpuinfo | grep sun8i`
if [ "$cpuinfo" != "" ]; then
    isH3Platform=true
    echo "It's H3 platform."
fi

#
# Detect chip number according to hash board type
#
if [ isH3Platform ]; then
    if [ -f /sys/class/hwmon/hwmon1/device/name ]; then
        name0=`cat /sys/class/hwmon/hwmon1/device/name`
    fi
    if [ -f /sys/class/hwmon/hwmon2/device/name ]; then
        name1=`cat /sys/class/hwmon/hwmon2/device/name`
    fi
    if [ -f /sys/class/hwmon/hwmon3/device/name ]; then
        name2=`cat /sys/class/hwmon/hwmon3/device/name`
    fi
else
    if [ -f /sys/class/hwmon/hwmon0/name ]; then
        name0=`cat /sys/class/hwmon/hwmon0/name`
    fi
    if [ -f /sys/class/hwmon/hwmon1/name ]; then
        name1=`cat /sys/class/hwmon/hwmon1/name`
    fi
    if [ -f /sys/class/hwmon/hwmon2/name ]; then
        name2=`cat /sys/class/hwmon/hwmon2/name`
    fi
fi

if [ "$name0" = "lm75" -o "$name1" = "lm75" -o "$name2" = "lm75" ]; then
    CHIP_NUM=38
else
    CHIP_NUM=66
fi

# Check parameters: <command> [device] [chip_num]
if [ "$1" -gt 0 ] 2>/dev/null; then
  DEV="/dev/ttyS2"
  CHIP_NUM=$1
else
    if [ "$1" = "" ]; then
        DEV="/dev/ttyS2"
    else
        DEV=$1
        if [ "$2" -gt 0 ] 2>/dev/null; then
            CHIP_NUM=$2
        fi
    fi
fi

#
# Command usage:
#
# bitmicro-test <device> <baud> <times> <progress> <command>
#               <chip_num> <core_num> <fan_speed> <need_retry> <retry_times>

# Reset all slots
if [ isH3Platform ]; then
    echo 0 > /sys/class/gpio/gpio99/value
    echo 0 > /sys/class/gpio/gpio100/value
    echo 0 > /sys/class/gpio/gpio101/value
else
    echo 0 > /sys/class/gpio/gpio960/value
    echo 0 > /sys/class/gpio/gpio962/value
    echo 0 > /sys/class/gpio/gpio964/value
fi

# Start to test
/bin/bitmicro-test $DEV 1000000 1 1 read_chip_model $CHIP_NUM 100 6000 1 10
