#!/bin/sh /etc/rc.common

START=80
STOP=20

isH3Platform=false

start() {
    cpuinfo=`cat /proc/cpuinfo | grep sun8i`
    if [ "$cpuinfo" != "" ]; then
        isH3Platform=true
    fi

    if [ "$isH3Platform" = true ]; then
        hwmon0_path="/sys/class/hwmon/hwmon1/device/"
        hwmon1_path="/sys/class/hwmon/hwmon2/device/"
        hwmon2_path="/sys/class/hwmon/hwmon3/device/"
        hwmon4_path="/sys/class/hwmon/hwmon5/device/"

        gpio0_path="/sys/class/gpio/gpio96/value"
        gpio1_path="/sys/class/gpio/gpio97/value"
        gpio2_path="/sys/class/gpio/gpio98/value"
    else
        hwmon0_path="/sys/class/hwmon/hwmon0/"
        hwmon1_path="/sys/class/hwmon/hwmon1/"
        hwmon2_path="/sys/class/hwmon/hwmon2/"
        hwmon4_path="/sys/class/hwmon/hwmon4/"

        gpio0_path="/sys/class/gpio/gpio934/value"
        gpio1_path="/sys/class/gpio/gpio939/value"
        gpio2_path="/sys/class/gpio/gpio937/value"        
    fi

    # Detect hash board type
    if [ -f $hwmon0_path/name ]; then
        name0=`cat $hwmon0_path/name`
    fi
    if [ -f $hwmon1_path/name ]; then
        name1=`cat $hwmon1_path/name`
    fi
    if [ -f $hwmon2_path/name ]; then
        name2=`cat $hwmon2_path/name`
    fi

    gpio0=`cat $gpio0_path`
    gpio1=`cat $gpio1_path`
    gpio2=`cat $gpio2_path`

    if [ "$name0" = "tmp421" -o "$name1" = "tmp421" -o "$name2" = "tmp421" ]; then
        if [ $gpio0 = "0" -o $gpio1 = "0" -o $gpio2 = "0" ]; then
            hash_board="HB20"
            miner_type="M1s"
        else
            hash_board="HB12"
            miner_type="M1"
        fi
    elif [ "$name0" = "lm75" -o "$name1" = "lm75" -o "$name2" = "lm75" ]; then
        if [ $gpio0 = "0" -o $gpio1 = "0" -o $gpio2 = "0" ]; then
            hash_board="ALB20"
            miner_type="M3"
        else
            hash_board="ALB10"
            miner_type="M2"
        fi
    else
        if [ -f $hwmon0_path/name ]; then
            name0=`cat $hwmon0_path/name`
        fi
        if [ -f $hwmon2_path/name ]; then
            name1=`cat $hwmon2_path/name`
        fi
        if [ -f $hwmon4_path/name ]; then
            name2=`cat $hwmon4_path/name`
        fi

        if [ "$name0" = "tmp423" -o "$name1" = "tmp423" -o "$name2" = "tmp423" ]; then
            hash_board="HB10"
            miner_type="M1"
        else
            hash_board="unknown"
            miner_type="unknown"
        fi
    fi

    logger "detect-cgminer-config: miner_type=$miner_type hash_board=$hash_board"

    if [ "$hash_board" = "unknown" ]; then
        exit 1;
    fi

    # Start linking files ...
    if [ "$hash_board" = "ALB10" ]; then
        CGMINERFILE="cgminer.alb10"
        CGMINERDEFAULTFILE="cgminer.default.alb10"
        POWERSFILE="powers.alb10"
    fi
    if [ "$hash_board" = "ALB20" ]; then
        CGMINERFILE="cgminer.alb20"
        CGMINERDEFAULTFILE="cgminer.default.alb20"
        POWERSFILE="powers.alb20"
    fi
    if [ "$hash_board" = "HB10" ]; then
        CGMINERFILE="cgminer.hash10"
        CGMINERDEFAULTFILE="cgminer.default.hash10"
        POWERSFILE="powers.hash10"
    fi
    if [ "$hash_board" = "HB12" ]; then
        CGMINERFILE="cgminer.hash12"
        CGMINERDEFAULTFILE="cgminer.default.hash12"
        POWERSFILE="powers.hash12"
    fi
    if [ "$hash_board" = "HB20" ]; then
        CGMINERFILE="cgminer.hash20"
        CGMINERDEFAULTFILE="cgminer.default.hash20"
        POWERSFILE="powers.hash20"
    fi

    if [ -f /etc/config/$CGMINERFILE ]; then
        DIFF=`cmp /etc/config/$CGMINERFILE /etc/config/cgminer`
        if [ ! -f /etc/config/cgminer -o "$DIFF" != "" ]; then
            cd /etc/config/
            rm -f cgminer
            ln -s $CGMINERFILE cgminer
            cd -
            logger "detect-cgminer-config: linking /etc/config/cgminer to /etc/config/$CGMINERFILE"
        else
            logger "detect-cgminer-config: /etc/config/cgminer remains unchanged"
        fi
    fi
    if [ -f /etc/config/$CGMINERDEFAULTFILE ]; then
        DIFF=`cmp /etc/config/$CGMINERDEFAULTFILE /etc/config/cgminer.default`
        if [ ! -f /etc/config/cgminer.default -o "$DIFF" != "" ]; then
            cd /etc/config/
            rm -f cgminer.default
            ln -s $CGMINERDEFAULTFILE cgminer.default
            cd -
            logger "detect-cgminer-config: linking /etc/config/cgminer.default to /etc/config/$CGMINERDEFAULTFILE"
        else
            logger "detect-cgminer-config: /etc/config/cgminer.default remains unchanged"
        fi
    fi
    if [ -f /etc/config/$POWERSFILE ]; then
        DIFF=`cmp /etc/config/$POWERSFILE /etc/config/powers`
        if [ ! -f /etc/config/powers -o "$DIFF" != "" ]; then
            cd /etc/config/
            rm -f powers
            ln -s $POWERSFILE powers
            cd -
            logger "detect-cgminer-config: linking /etc/config/powers to /etc/config/$POWERSFILE"
        else
            logger "detect-cgminer-config: /etc/config/powers remains unchanged"
        fi
    fi
}
