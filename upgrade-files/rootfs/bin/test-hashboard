#!/bin/sh
#
# Usages:
#
# 1. test-hashboard             (Default device: /dev/ttyS2)
# 2. test-hashboard /dev/ttyS3
#

if [ "$1" = "" ]; then
    DEV="/dev/ttyS2"
else
    DEV=$1
fi

#
# Detect chip number according to hash board type
#
if [ -f /sys/class/hwmon/hwmon0/name ]; then
    name0=`cat /sys/class/hwmon/hwmon0/name`
fi
if [ -f /sys/class/hwmon/hwmon1/name ]; then
    name1=`cat /sys/class/hwmon/hwmon1/name`
fi
if [ -f /sys/class/hwmon/hwmon2/name ]; then
    name2=`cat /sys/class/hwmon/hwmon2/name`
fi

if [ "$name0" = "lm75" -o "$name1" = "lm75" -o "$name2" = "lm75" ]; then
    CHIP_NUM=38
else
    CHIP_NUM=66
fi

#
# Command usage:
#
# bitmicro-test <device> <baud> <times> <progress> <command>
#               <chip_num> <core_num> <pass_chips> <pass_cores> <start_freq> <target_freq> <upfreq_interval>
#               <broadcast> <start_chipid> <end_chipid> <fan_speed> <temp_limit> <need_cool> <temp_cool>

# Reset all slots
echo 0 > /sys/class/gpio/gpio960/value
echo 0 > /sys/class/gpio/gpio962/value
echo 0 > /sys/class/gpio/gpio964/value

# Start to test
/bin/bitmicro-test $DEV 1000000 1 1 send_golden_work_to_all $CHIP_NUM 100 $CHIP_NUM 90 192 450 1000000 1 1 $CHIP_NUM 6000 70 1 50
